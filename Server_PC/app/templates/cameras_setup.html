
<!--This page is used to add and remove cameras -->

{% include 'header.html' %}

<h1 class="card">
    Remote camera streams configuration
</h1>

<div class="w3-row">


    <div class=" w3-col l8 m12 s12 card">
 
        <div id="main" style="width: 100%;height: 500px;"></div>         
 
    </div>

    <div class=" w3-col l3 m12 s12 card">
        <div class="w3-container">
            <h1 style="text-align: left;">Camera setup information</h1>
            <p class="regulartext">
                To add a camera, click on the 'Add' button on the top right corner of the grid. 
                A form will appear to fill in the camera details. 
                <br>
                <br>
                <b>Fields:</b>
                <br>
                <br>
                <b>Name:</b> The name of the camera.
                <br>
                <b>IP Address:</b> The IP address of the camera.
                <br>
                <b>Port:</b> The port of the camera.
                <br>
                <b>Stream Path:</b> The path of the stream.
                <br>
                <b>Email Alert:</b> The email to send alerts to.
                <br>
                <br>
                <br>
                <b>Setup Notes:</b>
                <br>
                <br>          
                - The 'IP Address' field must be a valid IP address.
                <br>
                - The 'Port' field must be a number between 1024 and 65536.
                <br>
                - The 'Stream Path' field must be a valid path for the remote camera stream.
                <br>
                - The 'Email Alert' field must be a valid email address.
                <br>
                - The 'Name' field must be a valid name.
                <br>
                - The 'Mirror port' field is assigned upon camera addition, non modifiable and is shown for information and testing purposes only.
                <br>
                - Hover over the field names to see the field descriptions.
                <b>Changes are saved automatically.</b>


            </p>
        </div>
    
    
</div>   

  
<script>
    //OnLoad event
    window.addEventListener('load',(event) => {

                //Top menu item selection
        //Collects all elements from 'nav' class
        var nav = document.getElementsByClassName("nav");
        //Removes the 'active' class from all elements
        for (var i = 0; i < nav.length; i++) {
            nav[i].classList.remove("active");
        }
        //Adds the 'active' class to the current page
        var current = document.getElementsByClassName("nav")[4];
        current.classList.add("active");



    });

    

    //GRID
    //Credit: https://w2ui.com
    let ans;
    
    let panelstyle = "box-sizing: border-box;";

    let config = {
    
    layout: {
        name: 'layout',
        padding: 4,
        panels: [
            { type: 'main', size: '80%',  style: 'overflow: hidden',style: panelstyle},
           
        ]
    },
      
    grid: {
        name: 'grid',
        url: '/w2ui_db',
        method: 'GET', // need this to avoid 412 error on Safari
        show:{
            footer: true,
            lineNumbers: true,
            toolbar: true,
            toolbarSearch: false,
            toolbarDelete: true,
            toolbarAdd: true,
        },
        columns: [
            { field: 'id', text: 'ID', size: '50px', sortable: true, hidden: true},
            { field: 'name', text: 'Name', size: '100px',  editable: { type: 'text' }, tooltip:"Camera name tag. Must be unique."},
            { field: 'ip_address', text: 'IP Address', size: '100px',  editable: { type: 'ipAddress' }, tooltip:"Camera IP address"},
            { field: 'port', text: 'Port', size: '50px', editable: { type: 'int' }, tooltip:"Camera tcp port"},
            { field: 'path', text: 'Stream Path', size: '100px',  editable: { type: 'text' }, tooltip:"Camera stream path (e.g. /video_feed)"},
            { field: 'emailAlert', text: 'Email', size: '150px',  editable: { type: 'email' }, tooltip:"Email to send alerts to"},
            { field: 'frameskip', text: 'Frame skip', size: '80px', editable: { type: 'int',min:0,max:10 }, tooltip:"Frames to skip from video (improves performance)"  },
            { field: 'detectionarea', text: 'Det. Area', size: '90px', editable: { type: 'int',min:0,max:76800 }, tooltip:"Detection area threshold in pixels" },
            { field: 'detectionthreshold', text: 'Threshold', size: '90px', editable: { type: 'int',min:0,max:255 }, tooltip:"Detection threshold contrast (0-255)"},
            { field: 'recordtime', text: 'Rec.Time', size: '80px', editable: { type: 'int',min:0,max:86400 }, tooltip:"Video recording time in seconds after movement detected" },
            { field: 'alertlength', text: 'Alert len.', size: '80px', editable: { type: 'int',min:0,max:86400 }, tooltip:"Alerting state length in seconds (lights/relay hardware)" },
            { field: 'mirrorport', text: 'Mirror port', size: '80px', tooltip:"System internal use. Do not edit."},
            { field: 'isTriggerable', text: 'Triggerable', size: '85px', editable: { type: 'checkbox'}, tooltip:"Activates or deactivates motion detection alerts" },
            { field: 'isEnabled', text: 'Enabled', size: '70px',  editable: { type: 'checkbox' }, tooltip:"Enables or disables a camera"}
        ],
        //A field was modified
        onChange: function(event) {
            
            //event.preventDefault();

            var colId=event.detail.column; //Edited column
            var colName=grid.columns[colId].field; //Edited column name
            var colValue=event.detail.value.new; //New value

            //Validate the value
            if (!validateFields(colName, colValue)){
                w2ui.grid.message('Wrong value!','error')
                    .then(event => {
                        //console.log('error', event)
                    })
                    .ok(event => {
                        //console.log('ok clicked', event)
                        grid.reload();
                    })
                return; //If the value is invalid, do not update the grid   
            }
            //Record the change
            //Lots of digging into the grid object here
            var grid_id = event.detail.index; // notice grid row not the same as id in the database
            var id = grid.records[grid_id].id;// id in the database
            var name = grid.records[grid_id].name; 
            var changedcolumnname =  grid.columns[event.detail.column].field;
            var newvalue = event.detail.value.new 
            //Prepare response
            var data={};
                data["name"]= name,
                data[changedcolumnname]= newvalue,
                data["id"]= parseInt(id);
                
            //Send the data to the server
            sendPost(data, "/modify_config", function(response){
                //grid.refresh();
                console.log(response);
            }); 
        },

        //Add button was clicked
        onAdd: function (event) {
           window.openPopup();
        },

        //Delete button was clicked
        onDelete: function (event) {
            //event.preventDefault();
            console.log(event);
    }
    }

    };


    window.openPopup = function() {
    if (!w2ui.inputForm) {
        new w2form({
            name: 'inputForm',
            style: 'border: 0px; background-color: transparent;',
            fields: [
                { field: 'name', type: 'text', required: true, html: { label: 'Name' } },
                { field: 'ip_address', type: 'ipAddress', required: true, html: { label: 'IP address' } },
                { field: 'port', type: 'int', required: true, html: { label: 'Port' } },
                { field: 'path', type: 'text', required: true, html: { label: 'Stream Path' } },
                { field: 'emailAlert', type: 'email', required: true, html: { label: 'Email Alert' } }
            ],
            actions: {
                Reset() { this.clear() },
                Save() { 
                    var isValid=this.validate();
                    
                        if (isValid.length == 0) {
                            let data = this.record;
                            sendPost(data, "/add_camera", function(response){
                                if(response == "Added"){  //Expected response
                                    w2popup.close();
                                    w2ui.grid.reload();
                                }else{
                                    w2popup.close();
                                    grid.error(response); //Prints the response (error message)
                                }
                                
                            });
                        }else{
                           
                            console.log('Fields are not valid');
                            
                        }
                
                }
            }
        });
    }
    w2popup.open({
        title   : 'Add Camera',
        body    : '<div id="form" style="width: 100%; height: 300px;"></div>',
        style   : 'padding: 15px 0px 0px 0px',
        width   : 400,
        height  : 360,
        showMax : true,
        async onToggle(event) {
            await event.complete
            w2ui.inputForm.resize();
        }
    })
    .then((event) => {
        w2ui.inputForm.render('#form')
    });
}




 //For validation of the form editions
 function validateFields(name, value) {
       
       // Regular expressions for validation
       var nameRegex = /^[a-zA-Z\s]+$/;
       var portRegex = /^\d+$/;
       var ipAddressRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
       var pathRegex = /^\/[a-zA-Z0-9_\/]*$|^\/$/;
       var emailRegex = /^\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,3}$/;

       if(name == "name"){
           if (!nameRegex.test(value)) {
               return false;
           } 
       }

       if(name == "port"){
           if (!portRegex.test(value) || value < 1024 || value > 65536) {
               return false;
           } 
       }

       if(name == "ip_address"){
           if (!ipAddressRegex.test(value)) {
               return false;
           } 
       }

       if(name == "path"){
           if (!pathRegex.test(value)) {
               return false;
           } 
       }

       if(name == "emailAlert"){
           if (!emailRegex.test(value)) {
               return false;
           } 
       }

        return true;
   }

// create layout
let layout = new w2layout(config.layout)
let grid = new w2grid(config.grid)

// initialization
layout.render('#main')
layout.html('main', grid)


    </script>

{% include 'footer.html' %}

