
<!--This page is used to add and remove cameras -->

{% include 'header.html' %}

<h1 class="card">
    <img src="/static/img/logo_mini.jpg"  class="logo-mini">
    Cameras List
</h1>

<div class="card">
    
        
        <div class="w3-row w3-content">
            
            <div class="w3-col l10 m12 s12">
              
            <div id="grid" style="width: 100%;height: 300px;"></div>
            
         
            </div>
        </div>
        

    <div class="row">
        <div style="text-align: left;"><h2>Add Camera</h2></div>
        <form action="/add_camera" method="post">
            <div class="row">
                <div class="input_textbox">
                    <div for="name">Camera Name</div>
                    <div><input type="text" id="name" name="name" required></div>
                </div>
                <div class="input_textbox">
                    <div for="port">Port</div>
                    <div><input type="text" id="port" name="port" required></div>
                </div>
                <div class="input_textbox">    
                    <div for="ip_address">IP Address</div>
                    <div><input type="text" id="ip_address" name="ip_address" required></div>
                </div>
                <div class="input_textbox">
                    <div for="path">Path</div>
                    <div><input type="text" id="path" name="path" required></div>
                </div>
                <div class="input_textbox">
                    <div for="emailAlert">Email Alert</div>
                    <div><input type="text" id="emailAlert" name="emailAlert" required></div>
                </div>
                <div class="input_textbox" style="display: flex;align-items: end;">
                    <div><input type="button" class="button" style="width: 100%;height:75%" value="Submit" onclick="doPost()"></div>
                </div>
            </div>   
        </form>
    </div>
        
    </div>



        
    </div>
    

       
        <div class="saveconfirm" id="result"></div>


    

        
<script>
    //OnLoad event
    window.addEventListener('load',(event) => {

                //Top menu item selection
        //Collects all elements from 'nav' class
        var nav = document.getElementsByClassName("nav");
        //Removes the 'active' class from all elements
        for (var i = 0; i < nav.length; i++) {
            nav[i].classList.remove("active");
        }
        //Adds the 'active' class to the current page
        var current = document.getElementsByClassName("nav")[4];
        current.classList.add("active");



    });

    function doPost() {
        var form = document.querySelector('form');

        //Validate fields
        if (!validateFields()){
            return;
        }


        
        event.preventDefault();
        var formData = new FormData(form);
        var xhr = new XMLHttpRequest();
        xhr.open('POST', form.action);
        xhr.onload = function() {
            if (xhr.status === 200) {
                location.reload();
            }
        };
        xhr.send(formData);

    }

    function validateFields() {
        var nameInput = document.getElementById('name');
        var portInput = document.getElementById('port');
        var ipAddressInput = document.getElementById('ip_address');
        var pathInput = document.getElementById('path');
        var emailAlertInput = document.getElementById('emailAlert');


        // Regular expressions for validation
        var nameRegex = /^[a-zA-Z\s]+$/;
        var portRegex = /^\d+$/;
        var ipAddressRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
        var pathRegex = /^[a-zA-Z0-9\/]+$/;
        var emailRegex = /^\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,3}$/;

        // Validate and change text color if format is incorrect
        if (!nameRegex.test(nameInput.value)) {
            nameInput.style.color = 'red';
            return false;
        } else {
            nameInput.style.color = '';
           
        }

        if (!portRegex.test(portInput.value)) {
            portInput.style.color = 'red';
            return false;
        } else {
            portInput.style.color = '';
        }

        if (!ipAddressRegex.test(ipAddressInput.value)) {
            ipAddressInput.style.color = 'red';
            return false;
        } else {
            ipAddressInput.style.color = '';
        }

        if (!pathRegex.test(pathInput.value)) {
            pathInput.style.color = 'red';
            return false;
        } else {
            pathInput.style.color = '';
        }

        if (!emailRegex.test(emailAlertInput.value)) {
            emailAlertInput.style.color = 'red';
            return false;
        } else {
            emailAlertInput.style.color = '';
        }
        return true;
    }


    //GRID
    //Credit: https://w2ui.com
    let ans;
    
    let grid = new w2grid({
        name: 'grid',
        box: '#grid',
        url: '/w2ui_db',
        //method: 'GET', // need this to avoid 412 error on Safari
        show:{
            footer: true,
            lineNumbers: true
        },
        columns: [
            { field: 'name', text: 'Name', size: '50%', sortable: true, editable: { type: 'text' }},
            { field: 'ip_address', text: 'IP Address', size: '100px', sortable: true, editable: { type: 'text' }  },
            { field: 'port', text: 'Port', size: '50px', editable: { type: 'int',min:1025,max:65535 } },
            { field: 'path', text: 'Stream Path', size: '50%', sortable: true, editable: { type: 'text' }  },
            { field: 'emailAlert', text: 'Alert Email to', size: '150px', sortable: true, editable: { type: 'email' }  },
            { field: 'isEnabled', text: 'Enabled', size: '70px', sortable: true, editable: { type: 'checkbox' }  }
        ],
        onChange: function(event) {
            //Lots of digging into the grid object here
            var id = event.detail.index;
            var name = grid.records[id].name; // notice grid id index is not the same as the id in the database (+1)
            var changedcolumnname =  grid.columns[event.detail.column].field;
            var newvalue = event.detail.value.new 

            var data={};
                data["name"]= grid.records[id].name,
                data[changedcolumnname]= newvalue,
                data["id"]= id+1
                

            sendPost(data, "/modify_config", function(){
                //grid.refresh();
                console.log("Updated");
            }); 
        }
    })



    </script>

{% include 'footer.html' %}

